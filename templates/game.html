<div class="w-screen h-full relative bg-green-700 bg-[url('/img/noisy-texture.png')] bg-repeat z-1">
  <div id="gameEnd" class="w-screen h-full absolute bg-gray-900 z-10 flex flex-col justify-center hidden">
    <p id="winnerName" class="glowing text-white text-center font-extrabold logo-1 text-4xl">
    </p>
    <p class="glowing text-white text-center font-extrabold text-2xl">
      wins
    </p>
    <p id="chips" class="glowing text-white text-center font-extrabold logo-1 text-2xl">
    </p>
    <div class="text-center text-white">
      <button type="button" id="newGameBtn" onclick="startGame()" class="px-4 py-1 text-sm text-purple-600 font-semibold rounded-full border border-purple-200 hover:text-white hover:bg-purple-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Play again!</button>
    </div>
  </div>
  <div id="errorsContainer" class="absolute top-0 right-0 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
  </div> 
  <div id="playersContainer" class="h-20">
  </div>
  <div id="table" class="p-2 pt-6 max-w-[60%] mx-auto bg-white rounded-xl shadow-lg my-10 relative">
      <button type="button" id="nextStreetBtn" onclick="nextStreet()" class="px-4 py-1 text-sm text-purple-600 font-semibold rounded-full border border-purple-200 hover:text-white hover:bg-purple-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Advance</button>
      <div class="flex justify-center">
        <div id="potHolder" class="p-2 text-center bg-white font-semibold text-red-500 absolute top-[-20px] rounded-xl shadow-xl ring ring-4 ring-red-700">
        </div>
      </div>
      
      <div id="commonCards" class="bg-gray-200 w-full h-16 flex items-center justify-center gap-1">
      </div>
      <div class="bg-gray-100">
        <div id="status" class="inline-block text-left text-sm italic text-gray-700"></div>
        <div id="minRaise" class="inline-block float-right text-right text-sm italic text-gray-700"></div>
      </div>
      <div id="results" class="text-center mx-auto">
      </div>
      <div id="lastAction" class="text-small text-gray-400 italics text-center">
      </div>
  </div>
  <div id="self" class="mx-[25%]">
    <!--JS will populate a player inside here with appropriate styling-->
  </div>
 
  <div id="actions" class="py-2 px-2 flex justify-center w-full bg-white absolute left-0 bottom-0 items-end">
      <div class="my-2 mx-2">
        <!-- can only call or check on a given turn, not both. So we put both in the same div-->
        <button type="button" id="checkBtn" onclick="check()" class="px-4 py-1 text-sm text-purple-600 font-semibold rounded-full border border-purple-200 hover:text-white hover:bg-purple-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Check</button>
        <button type="button" id="callBtn" onclick="call()" class="px-4 py-1 text-sm text-purple-600 font-semibold rounded-full border border-purple-200 hover:text-white hover:bg-purple-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Call</button>
      </div>
      <div class="my-2 mx-2 text-center">
        <label id="betLabel"></label>
        <div class="relative text-gray-700">
            <input id="betAmount" class="w-full min-w-[120px] h-10 pl-3 pr-8 text-base placeholder-gray-600 border rounded-lg focus:shadow-outline" type="number" placeholder="Amount"/>
            <button id="betBtn" onclick="bet()" class="absolute inset-y-0 right-0 flex items-center px-4 font-bold text-white bg-indigo-600 rounded-r-lg hover:bg-indigo-500 focus:bg-indigo-700">Bet</button>
        </div>
    </div>
    <div class="my-2 mx-2">
      <button type="button" id="allInBtn" onclick="allIn()" class="px-4 py-1 text-sm text-purple-600 font-semibold rounded-full border border-purple-200 hover:text-white hover:bg-purple-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">All In</button>
    </div>
    <div class="my-2 mx-2">
      <button type="button" id="foldBtn" onclick="fold()" class="px-4 py-1 text-sm text-purple-600 font-semibold rounded-full border border-purple-200 hover:text-white hover:bg-purple-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Fold</button>
    </div>
  </div>
</div>
    
<script src="/socket.io/socket.io.js"></script>
<script src="/js/menus.js"></script>
<script src="/js/socket.js"></script>
<script src="/js/pyro.js"></script>
<script>
    // Eventually convert this to react probably. But iterating with pure JS is easy.
    function updateActions(actionsOpts, currentPlayerId){
      console.log("actions are: ", actionsOpts, " for playerId: ", currentPlayerId);
      var callBtn = document.getElementById("callBtn");
      var checkBtn = document.getElementById("checkBtn");
      var foldBtn = document.getElementById("foldBtn");
      var betLabel = document.getElementById("betLabel");
      var betInput = document.getElementById("betAmount");
      var betBtn = document.getElementById("betBtn");
      var allInBtn = document.getElementById("allInBtn");
      if (actionsOpts && actionsOpts.call){
        callBtn.classList.remove("hidden");
        callBtn.innerHTML = "Call: " + actionsOpts.call;
      } else {
        callBtn.classList.remove("hidden");
        callBtn.classList.add("hidden");
      }
      if (actionsOpts && actionsOpts.fold){
        foldBtn.classList.remove("invisible");
      } else {
        foldBtn.classList.remove("invisible");
        foldBtn.classList.add("invisible");
      }
      if (actionsOpts && actionsOpts.check){
        checkBtn.classList.remove("hidden");
      } else {
        checkBtn.classList.remove("hidden");
        checkBtn.classList.add("hidden");
      }
      if (actionsOpts && actionsOpts.allIn){
        allInBtn.classList.remove("invisible");
        allInBtn.innerHTML = "All in: " + actionsOpts.allIn;
      } else {
        allInBtn.classList.remove("invisible");
        allInBtn.classList.add("invisible");
      }
      if (actionsOpts && actionsOpts.bet && actionsOpts.bet.length > 1){
        betBtn.classList.remove("invisible");
        betLabel.classList.remove("invisible");
        betInput.classList.remove("invisible");
        betInput.min = actionsOpts.bet[0];
        betInput.max = actionsOpts.bet[1];
        betLabel.innerHTML = actionsOpts.bet[0] + " to " + actionsOpts.bet[1];
      } else {
        betBtn.classList.remove("invisible");
        betBtn.classList.add("invisible");
        betInput.classList.remove("invisible");
        betInput.classList.add("invisible")
        betLabel.classList.remove("invisible");
        betLabel.classList.add("invisible");
      }
    }
    function toggleAdvanceButton(status){
      let advanceButton = document.getElementById('nextStreetBtn');
      if (status == "auto-advance"){
        advanceButton.classList.remove('hidden');
      } else {
        advanceButton.classList.remove('hidden');
        advanceButton.classList.add('hidden');
      }
    }

    function renderGameStatus(status){
      let statusDiv = document.getElementById('status');
      let winningScreen = document.getElementById('gameEnd');
      winningScreen.classList.remove("hidden");
      winningScreen.classList.add("hidden");
      if (typeof(status) != 'undefined'){
        statusDiv.innerHTML = status;
        if (status == 'complete'){
          winningScreen.classList.remove("hidden");
          let winnerName = document.getElementById('winnerName');
          let chips = document.getElementById('chips');
          winnerName.innerHTML = 'What?';
          chips.innerHTML = '5000 chips!';
          for (let i=0; i < 10; i++){
            setTimeout(createFirework, fw_launch_rate * i);
          }
        }
      } else {
        statusDiv.innerHTML = "";
      }
    }

    function updateResults(results){
      // results is an array of winners for each pot
      var resultsDiv = document.getElementById("results");
      if (results.length > 0){
        let dealButton = document.createElement('button');
        let resultText = document.createElement('div');
        resultText.className = "font-semibold text-gray-800 p-2 m-2 bg-green-200 rounded-xl shadow-lg"
        dealButton.id = "nextHandBtn";
        dealButton.className = "mx-1 px-4 py-1 text-sm font-semibold rounded-full border border-purple-200 text-white bg-purple-600 border-transparent outline-none ring-2 ring-purple-600 ring-offset-2";
        dealButton.type = "button";
        dealButton.onclick = nextHand;
        dealButton.innerHTML = "Deal";
        let resultString = "";
        results.forEach(function(potResult){
          potResult.forEach(function(winner){
            resultString = resultString + "Winner: " + winner.winner_name + "!<br>" + winner.amount + ' chips<br>' + 'Hand: ' + winner.winning_hand;
          })
        })
        resultText.innerHTML = resultString;
        resultsDiv.appendChild(resultText);
        resultsDiv.appendChild(dealButton);
      } else {
        resultsDiv.innerHTML = "";
      }
    }

    function updateLastAction(lastActionString){
      let lastActionDiv = document.getElementById('lastAction');
      if (lastActionDiv){
        lastActionDiv.innerHTML = lastActionString;
      }
    }

    function updateAllPlayers(playersInfo, currentPlayerId){
      let containerDiv = document.getElementById('playersContainer');
      containerDiv.innerHTML = "";
      let selfContainer = document.getElementById('self');
      selfContainer.innerHTML = "";
      // cycle through each player, starting at self.
      let startArrayPosition = playersInfo.map(function(o) { return o.playerId; }).indexOf(currentPlayerId);
      for (var i = startArrayPosition; i < playersInfo.length + startArrayPosition; i++) {
        let j = i % playersInfo.length;
        console.log("updating player at: ", j);
        if (playersInfo[j]["playerId"] == currentPlayerId){
          addAPlayer(selfContainer, playersInfo[j]);
        } else {
          addAPlayer(containerDiv, playersInfo[j]);
        }
      }
      arrangePlayers(containerDiv);
    }

    function addAPlayer(container, playerInfo) {
            let playerId = playerInfo["playerId"];
            container.appendChild(renderPlayer(playerInfo));
            var playerBox = document.getElementById("player" + playerId);
            var chipLabel = document.getElementById("player" + playerId + "chips");
            var nameLabel = document.getElementById("player" + playerId + "name");
            var buttonLabel = document.getElementById("player" + playerId + "button");
            var smallBlindLabel = document.getElementById("player" + playerId + "smallBlind");
            var bigBlindLabel = document.getElementById("player" + playerId + "bigBlind");
            var handLabel = document.getElementById("player" + playerId + "hand"); 

            if (playerBox){
              if (playerInfo.handState == "FOLD" || playerInfo.gameState == "OUT"){
                playerBox.classList.remove('bg-white');
                playerBox.classList.remove('shadow-lg');
                playerBox.classList.add('bg-slate-300');
              } else {
                playerBox.classList.remove('bg-slate-300');
                playerBox.classList.add('shadow-lg');
                playerBox.classList.add('bg-white');
              }
            }
            if (chipLabel){
                chipLabel.innerHTML = playerInfo["chips"];
            }
            if (nameLabel){
                nameLabel.innerHTML = playerInfo["name"];
            }
            if (buttonLabel){
              if (playerInfo["button"]){
                buttonLabel.classList.remove("hidden");
                buttonLabel.innerHTML = "D";
              } else {
                buttonLabel.classList.remove("hidden");
                buttonLabel.classList.add("hidden");
                buttonLabel.innerHTML = "";
              }  
            }
            if (smallBlindLabel){
              if (playerInfo["smallBlind"]){
                smallBlindLabel.classList.remove("hidden");
                smallBlindLabel.innerHTML = "SB";
              } else {
                smallBlindLabel.classList.remove("hidden");
                smallBlindLabel.classList.add("hidden");
                smallBlindLabel.innerHTML = "";
              }
            }
            if (bigBlindLabel){
              if (playerInfo["bigBlind"]){
                bigBlindLabel.classList.remove("hidden");
                bigBlindLabel.innerHTML = "BB";
              } else {
                bigBlindLabel.classList.remove("hidden");
                bigBlindLabel.classList.add("hidden");
                bigBlindLabel.innerHTML = "";
              }
            }
            if (handLabel){
              var handString = ""
              for (let j = 0; j < playerInfo["hand"].length; j++) {
                handString = handString + renderCard(playerInfo["hand"][j]);
              }
              handLabel.innerHTML = handString;
            }
    }

    function arrangePlayers(container){
      let players = container.getElementsByClassName("player-box");
      let screenWidth = screen.width;
      let screenHeight = screen.height;
      let playersCount = players.length;
      let playerBoxWidth = 133; //px width of box
      let playerBoxHeight = 100;

      switch (playersCount){
        case 1:
          // put at top middle of screen
          players[0].style="position:absolute; left:" + (screenWidth/2 - playerBoxWidth/2) + "px;" + "top:0px;";
          break;
        case 2:
          // put at upper left and upper right
          players[0].style="position:absolute; left:" + "0" + "px;" + "top:0px;";
          players[1].style="position:absolute; right:" + "0" + "px;" + "top:0px;";
          break;
        case 3:
          // put at mid left, upper middle, and mid right
          players[0].style="position:absolute; left:" + "0" + "px;" + "top:" + (screenHeight/2 - playerBoxHeight) + "px;";
          players[1].style="position:absolute; left:" + (screenWidth/2 - playerBoxWidth/2) + "px;" + "top:0px;";
          players[2].style="position:absolute; right:" + "0" + "px;" + "top:" + (screenHeight/2 - playerBoxHeight) + "px;";
          break;
        case 4:
          // put at mid left, two across top and mid right
          players[0].style="position:absolute; left:" + "0" + "px;" + "top:" + (screenHeight/2 - playerBoxHeight) + "px;";
          players[1].style="position:absolute; left:" + (screenWidth/2 - playerBoxWidth) + "px;" + "top:0px;";
          players[2].style="position:absolute; left:" + (screenWidth/2 + playerBoxWidth) + "px;" + "top:0px;";
          players[3].style="position:absolute; right:" + "0" + "px;" + "top:" + (screenHeight/2 - playerBoxHeight) + "px;";
          break;
        case 5:
          // put at mid left, three across top and mid right
          players[0].style="position:absolute; left:" + "0" + "px;" + "top:" + (screenHeight/2 - playerBoxHeight) + "px;";
          players[1].style="position:absolute; left:" + (screenWidth/2 - 2*playerBoxWidth) + "px;" + "top:" + playerBoxHeight + "px;";
          players[2].style="position:absolute; left:" + (screenWidth/2 - playerBoxWidth/2) + "px;" + "top:" + playerBoxHeight + "px;";
          players[3].style="position:absolute; left:" + (screenWidth/2 + 2*playerBoxWidth) + "px;" + "top:" + playerBoxHeight + "px;";
          players[4].style="position:absolute; right:" + "0" + "px;" + "top:" + (screenHeight/2 - playerBoxHeight) + "px;";
          break;
        case 6:
          // put at two left, two across top and two right
          players[0].style="position:absolute; left:" + "0" + "px;" + "top:" + 2*playerBoxHeight + "px;";
          players[1].style="position:absolute; left:" + "0" + "px;" + "top:" + playerBoxHeight + "px;";
          players[2].style="position:absolute; left:" + (screenWidth/2 - playerBoxWidth/2) + "px;" + "top:" + playerBoxHeight + "px;";
          players[3].style="position:absolute; left:" + (screenWidth/2 + 2*playerBoxWidth) + "px;" + "top:" + playerBoxHeight + "px;";
          players[4].style="position:absolute; right:" + "0" + "px;" + "top:" + playerBoxHeight + "px;";
          players[5].style="position:absolute; right:" + "0" + "px;" + "top:" + 2*playerBoxHeight + "px;";
          break;
      }
    }

    function updateTable(table){
      if (table){
        document.getElementById("minRaise").innerHTML = "Min raise: " + table["minRaise"];
        // table can and will have multiple pots
        showPots(table["pots"]);
        showCommonCards(table["commonCards"]);
      }
    } 

    function showPots(potsObject){
      if (potsObject){
        let potHolder = document.getElementById('potHolder');
        let keys = Object.keys(potsObject);
        potHolder.innerHTML = "";
        keys.forEach(function(key, index){
          let pot = potsObject[key];
          let keys2 = Object.keys(pot.playerAmounts);
          let potDiv = document.createElement('div');
          potDiv.class = 'pot'
          potDiv.id = 'pot' + index;
          let total = 0;
          keys2.forEach(function(key2){
            total = total + pot.playerAmounts[key2].amount;
          })
          potDiv.innerHTML = "Pot: " + total;
          potHolder.appendChild(potDiv);
        })
      }
    }
    function activatePlayer(playersInfo, table){
      if (table["activeIndex"] !== 'undefined' && table["activeIndex"] != null){
        var activePlayer = playersInfo[table["activeIndex"]];
        for (let i = 0; i < playersInfo.length; i++) {
            var playerBox = document.getElementById("player" + playersInfo[i]["playerId"]);
            if (playerBox){
                playerBox.classList.remove("ring-4");
                playerBox.classList.remove("ring-red-700");
                if (playersInfo[i]["playerId"] == activePlayer.playerId) {
                  playerBox.classList.add("ring-4");
                  playerBox.classList.add("ring-red-700");
                }
            } 
        }
      }
    }
    
    function showCommonCards(cardArray){
        let cardDiv = document.getElementById("commonCards"); 
        cardDiv.innerHTML = ""; // clear list first
        for (let i = 0; i < 5; i++) {
            let newCard = document.createElement('div');
            newCard.classList = "ring ring-red-300 rounded-lg p-2";
            if (i < cardArray.length){
              newCard.innerHTML = renderCard(cardArray[i]);
            } else {
              newCard.innerHTML = "*";
            }
            cardDiv.appendChild(newCard);
        }
    }

    function renderCard(cardString){
      var num = cardString.charAt(0);
      var suit = cardString.charAt(1);
      if (num == "T"){
        num = "10";
      }
      return (num + htmlSuit(suit))
    } 
    function htmlSuit(suitString){
      switch (suitString) {
        case 'c':
          return "♣";
        case 'd':
          return "🔸";
        case 'h':
          return "🧡";
        case 's':
          return "♠";
        default:
          console.log(`Sorry, no suit match for  ${suitString}.`);
          return suitString;
      }
    }

    function renderErrors(errorsArray){
      let errorDiv = document.getElementById('errorsContainer');
      if (errorsArray.length > 0){
        errorDiv.classList.remove("hidden");
        errorDiv.innerHTML = JSON.stringify(errorsArray);
      } else {
        errorDiv.innerHTML = "";
        errorDiv.classList.remove("hidden");
        errorDiv.classList.add("hidden");
      }
    }

    function renderPlayer(player){
      let playerDiv = document.createElement('div');
      let playerName = document.createElement('div');
      let playerPosition = document.createElement('div');
      let playerButton = document.createElement('div');
      let playerSmallBlind = document.createElement('div');
      let playerBigBlind = document.createElement('div');
      let playerChips = document.createElement('p');
      let playerHand = document.createElement('p');

      playerDiv.id = 'player' + player.playerId;
      playerDiv.className = 'player-box p-4 max-w-sm mx-auto bg-white rounded-xl shadow-lg text-center relative';
      playerName.id = 'player' + player.playerId + 'name';
      playerName.className = 'text-xl font-medium';
      playerChips.id = 'player' + player.playerId + 'chips';
      playerChips.className = 'text-slate-500 absolute right-[-8px] top-[-8px] ring-4 ring-red-300 rounded-xl p-2';
      playerHand.id = 'player' + player.playerId + 'hand';
      playerHand.className = 'text-slate-500';
      playerPosition.id = 'player' + player.playerId + 'position';
      playerPosition.className = 'flex gap-1 absolute bottom-[-8px]';
      playerButton.id = 'player' + player.playerId + 'button';
      playerButton.className = 'bg-black rounded-xl ring-2 ring-gray-300 ring-inset text-white font-bold px-2';
      playerSmallBlind.id = 'player' + player.playerId + 'smallBlind';
      playerSmallBlind.className = 'bg-blue-400 rounded-xl ring-2 ring-blue-500 ring-inset text-white font-bold px-2';
      playerBigBlind.id = 'player' + player.playerId + 'bigBlind';
      playerBigBlind.className = 'bg-green-400 rounded-xl ring-2 ring-green-500 ring-inset text-white font-bold px-2';


      // '<div id="player1" class="p-6 max-w-sm mx-auto bg-white rounded-xl shadow-lg items-center">'
      //     <div id="player1name" class="text-xl font-medium"></div>
      //     <p id="player1chips" class="text-slate-500"></p>
      //     <p id="player1hand" class="text-slate-500"></p>
      //     <div id="player1button" class="bg-white rounded-xl ring-2 ring-pink-300 ring-inset"></div>
      //     <div id="player1smallBlind" class="bg-blue rounded-xl ring-2 ring-pink-300 ring-inset"></div>
      //     <div id="player1bigBlind" class="bg-yellow rounded-xl ring-2 ring-pink-300 ring-inset"></div>
      // </div>'
      playerDiv.appendChild(playerName);
      playerDiv.appendChild(playerChips);
      playerDiv.appendChild(playerHand);
      playerPosition.appendChild(playerButton);
      playerPosition.appendChild(playerSmallBlind);
      playerPosition.appendChild(playerBigBlind);
      playerDiv.appendChild(playerPosition);
      return playerDiv;
    }
</script>
