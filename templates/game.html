<div class="w-screen h-full relative bg-green-700 bg-[url('/img/noisy-texture.png')] bg-repeat z-1">
<!-- For felt background: add bg-green-700 bg-[url('/img/noisy-texture.png')] bg-repeat z-1 --->
  <div id="gameEnd" class="w-screen h-full absolute bg-gray-900 z-10 flex flex-col justify-center hidden">
    <p id="winnerName" class="glowing text-white text-center font-extrabold logo-1 text-4xl">
    </p>
    <p class="glowing text-white text-center font-extrabold text-2xl">
      wins
    </p>
    <p id="chips" class="glowing text-white text-center font-extrabold logo-1 text-2xl">
    </p>
    <div class="text-center text-white">
      <button type="button" id="newGameBtn" onclick="startGame()" class="px-4 py-1 text-sm text-purple-600 font-semibold rounded-full border border-purple-200 hover:text-white hover:bg-purple-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Play again!</button>
    </div>
  </div>

  <div id="errorsContainer" class="absolute top-0 right-0 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
  </div>

  <div id="playersContainerTop" class="h-28 w-full absolute top-0 flex justify-center p-2 gap-8">
  </div>
  <div id="playersContainerLeft" class="w-28 h-full py-28 absolute left-0 flex flex-col justify-center px-2 gap-8">
  </div>
  <div id="playersContainerRight" class="w-28 h-full py-28 absolute right-0 flex flex-col justify-center px-2 gap-8">
  </div>

  <div id="table" class="h-full w-full mx-auto absolute bottom-0 pb-40 pt-8 flex-col flex justify-center z-5">
      <div class="flex flex-col justify-center align-middle">
        <div id="potHolder" class="p-2 m-2 w-60 text-center text-white font-semibold bg-green-600 rounded mx-auto">
        </div>
        <div id="commonCards" class="w-full h-16 flex items-center justify-center gap-1">
        </div>
      </div>
      <div id="results" class="w-60 text-center mx-auto">
      </div>
  </div>

  <div class="flex w-screen justify-center absolute mb-24 bottom-0">
    <div id="self" class="mx-auto z-1">
      <!--JS will populate a player inside here with appropriate styling-->
    </div>
  </div>
  
 
  <div id="bottomBar"class="w-full absolute left-0 bottom-0">
    <div id="lastAction" class="text-sm text-gray-400 italics text-center"></div>
    <div id="betLabel" class="bg-white text-center text-sm"></div>
    <div id="actions" class="bg-white border-t">
      <div class="flex justify-center items-end text-center divide-x border-t">
        <div class="w-3/12">
          <button type="button" id="nextStreetBtn" onclick="nextStreet()" class="w-full h-16 px-4 py-1 text-sm text-indigo-600 font-semibold hover:text-white hover:bg-indigo-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2">Advance</button>
          <button type="button" id="startGameBtn" onclick="startGame()" class="w-full h-16 px-4 py-1 text-sm text-indigo-600 font-semibold hover:text-white hover:bg-indigo-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2">Start Game</button>
          <!-- can only call or check on a given turn, not both. So we put both in the same div-->
          <button type="button" id="checkBtn" onclick="check()" class="w-full h-16 px-4 py-1 text-sm text-indigo-600 font-semibold hover:text-white hover:bg-indigo-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2">Check</button>
          <button type="button" id="callBtn" onclick="call()" class="w-full h-16 px-4 py-1 text-sm text-indigo-600 font-semibold hover:text-white hover:bg-indigo-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Call</button>
        </div>
        <div class="w-3/12">
          
          <div class="text-gray-700 w-full h-16 text-center">
              <input id="betAmount" class="w-full h-8 px-4 text-center text-base placeholder-gray-400 focus:shadow-outline" type="number" placeholder="Amount"/>
              <button id="betBtn" onclick="bet()" class="w-full h-8 inset-y-0 px-4 font-bold text-white bg-indigo-600 hover:bg-indigo-500 focus:bg-indigo-700">Bet</button>
          </div>
        </div>
        <div class="w-3/12">
          <button type="button" id="allInBtn" onclick="allIn()" class="w-full h-16 px-4 py-1 text-sm text-indigo-600 font-semibold hover:text-white hover:bg-inditext-indigo-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-inditext-indigo-600 focus:ring-offset-2">All In</button>
        </div>
        <div class="w-3/12">
          <button type="button" id="foldBtn" onclick="fold()" class="w-full h-16 px-4 py-1 text-sm text-indigo-600 font-semibold hover:text-white hover:bg-inditext-indigo-600 hover:border-transparent focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2">Fold</button>
        </div>
      </div>
    </div>
  </div>
</div>
    
<script src="/socket.io/socket.io.js"></script>
<script src="/js/menus.js"></script>
<script src="/js/socket.js"></script>
<script src="/js/pyro.js"></script>
<script>
    // Eventually convert this to react probably. But iterating with pure JS is easy.
    function updateActions(actionsOpts, currentPlayerId){
      console.log("actions are: ", actionsOpts, " for playerId: ", currentPlayerId);
      var callBtn = document.getElementById("callBtn");
      var checkBtn = document.getElementById("checkBtn");
      var foldBtn = document.getElementById("foldBtn");
      var betLabel = document.getElementById("betLabel");
      var betInput = document.getElementById("betAmount");
      var betBtn = document.getElementById("betBtn");
      var allInBtn = document.getElementById("allInBtn");
      if (actionsOpts && actionsOpts.call){
        callBtn.classList.remove("hidden");
        callBtn.innerHTML = "Call: " + actionsOpts.call;
      } else {
        callBtn.classList.remove("hidden");
        callBtn.classList.add("hidden");
      }
      if (actionsOpts && actionsOpts.fold){
        foldBtn.classList.remove("invisible");
      } else {
        foldBtn.classList.remove("invisible");
        foldBtn.classList.add("invisible");
      }
      if (actionsOpts && actionsOpts.check){
        checkBtn.classList.remove("hidden");
      } else {
        checkBtn.classList.remove("hidden");
        checkBtn.classList.add("hidden");
      }
      if (actionsOpts && actionsOpts.allIn){
        allInBtn.classList.remove("invisible");
        allInBtn.innerHTML = "All in: " + actionsOpts.allIn;
      } else {
        allInBtn.classList.remove("invisible");
        allInBtn.classList.add("invisible");
      }
      if (actionsOpts && actionsOpts.bet && actionsOpts.bet.length > 1){
        betBtn.classList.remove("invisible");
        betLabel.classList.remove("invisible");
        betInput.classList.remove("invisible");
        betInput.min = actionsOpts.bet[0];
        betInput.max = actionsOpts.bet[1];
        betLabel.innerHTML = "Your betting range: " + actionsOpts.bet[0] + " to " + actionsOpts.bet[1];
      } else {
        betBtn.classList.remove("invisible");
        betBtn.classList.add("invisible");
        betInput.classList.remove("invisible");
        betInput.classList.add("invisible")
        betLabel.classList.remove("invisible");
        betLabel.classList.add("invisible");
      }
    }
    function toggleAdvanceButton(status){
      let advanceButton = document.getElementById('nextStreetBtn');
      if (status == "auto-advance"){
        advanceButton.classList.remove('hidden');
      } else {
        advanceButton.classList.remove('hidden');
        advanceButton.classList.add('hidden');
      }
    }

    function getLeader(players){
      let leader = players[0];
      players.forEach(p => {
        if (p.chips > leader.chips){
          leader = p;
        }
      })
      return leader;
    }

    function renderGameStatus(status, players){
      let winningScreen = document.getElementById('gameEnd');
      let startGameBtn = document.getElementById('startGameBtn');
      winningScreen.classList.remove("hidden");
      winningScreen.classList.add("hidden");
      if (typeof(status) != 'undefined'){
        if (status == 'complete'){
          let winner = getLeader(players);
          winningScreen.classList.remove("hidden");
          let winnerName = document.getElementById('winnerName');
          let chips = document.getElementById('chips');
          winnerName.innerHTML = winner.name;
          chips.innerHTML = winner.chips +  " chips!";
          for (let i=0; i < 10; i++){
            setTimeout(createFirework, fw_launch_rate * i);
          }
        } else if (status == 'unstarted'){
          // Show start button if game is unstarted
          startGameBtn.classList.remove("hidden");
        } else {
          // status is some thing else
          startGameBtn.classList.remove("hidden");
          startGameBtn.classList.add("hidden");
        }
      }
    }

    function updateResults(results){
      // results is an array of winners for each pot
      var resultsDiv = document.getElementById("results");
      if (results.length > 0){
        let dealButton = document.createElement('button');
        let resultText = document.createElement('div');
        resultText.className = "font-semibold text-gray-800 p-2 m-2 bg-gray-200 border shadow-lg"
        dealButton.id = "nextHandBtn";
        dealButton.className = "m-2 px-4 py-1 text-sm font-semibold rounded-full border border-purple-200 text-white bg-purple-600 border-transparent outline-none ring-2 ring-purple-600 ring-offset-2";
        dealButton.type = "button";
        dealButton.onclick = nextHand;
        dealButton.innerHTML = "Deal";
        let resultString = "";
        results.forEach(function(potResult){
          potResult.forEach(function(winner){
            resultString = resultString + "Winner: " + winner.winner_name + "!<br>" + winner.amount + ' chips<br>' + 'Hand: ' + winner.winning_hand;
          })
        })
        resultText.innerHTML = resultString;
        resultsDiv.appendChild(resultText);
        resultsDiv.appendChild(dealButton);
      } else {
        resultsDiv.innerHTML = "";
      }
    }

    function updateLastAction(lastActionString){
      let lastActionDiv = document.getElementById('lastAction');
      if (lastActionDiv){
        lastActionDiv.innerHTML = lastActionString;
      }
    }

    function updateAllPlayers(playersInfo, currentPlayerId){
      let containerTop = document.getElementById('playersContainerTop');
      let containerLeft = document.getElementById('playersContainerLeft');
      let containerRight = document.getElementById('playersContainerRight');
      containerTop.innerHTML = "";
      containerLeft.innerHTML = "";
      containerRight.innerHTML = "";
      let selfContainer = document.getElementById('self');
      selfContainer.innerHTML = "";
      // cycle through each player, starting at self.
      let startArrayPosition = playersInfo.map(function(o) { return o.playerId; }).indexOf(currentPlayerId);
      let otherPlayers = [];
      for (var i = startArrayPosition; i < playersInfo.length + startArrayPosition; i++) {
        let j = i % playersInfo.length;
        console.log("updating player at: ", j);
        if (playersInfo[j]["playerId"] == currentPlayerId){
          selfContainer.appendChild(renderPlayer(playersInfo[j]));
        } else {
          otherPlayers.push(renderPlayer(playersInfo[j]))
        }
      }
      arrangePlayers(containerTop,containerLeft,containerRight, otherPlayers);
      for (var i = 0; i < playersInfo.length; i++) {
        updatePlayer(playersInfo[i]);
      }
    }

    function updatePlayer(playerInfo) {
            let playerId = playerInfo["playerId"];
            var playerBox = document.getElementById("player" + playerId);
            var chipLabel = document.getElementById("player" + playerId + "chips");
            var nameLabel = document.getElementById("player" + playerId + "name");
            var buttonLabel = document.getElementById("player" + playerId + "button");
            var smallBlindLabel = document.getElementById("player" + playerId + "smallBlind");
            var bigBlindLabel = document.getElementById("player" + playerId + "bigBlind");
            var handLabel = document.getElementById("player" + playerId + "hand"); 

            if (playerBox){
              if (playerInfo.handState == "FOLD" || playerInfo.gameState == "OUT"){
                playerBox.classList.remove('bg-white');
                playerBox.classList.remove('shadow-lg');
                playerBox.classList.add('bg-slate-300');
              } else {
                playerBox.classList.remove('bg-slate-300');
                playerBox.classList.add('shadow-lg');
                playerBox.classList.add('bg-white');
              }
            }
            if (chipLabel){
                chipLabel.innerHTML = playerInfo["chips"];
            }
            if (nameLabel){
                nameLabel.innerHTML = playerInfo["name"];
            }
            if (buttonLabel){
              if (playerInfo["button"]){
                // Active look
                buttonLabel.className = "rounded-xl font-bold px-2 ring-inset bg-gray-800 ring-black ring-offset-2 text-white";
              } else {
                // Inactive look
                buttonLabel.className = "rounded-xl font-bold px-2 ring-inset bg-gray-100 ring-gray-300 ring-offset-2 text-gray-300";
              }  
            }
            if (smallBlindLabel){
              if (playerInfo["smallBlind"]){
                smallBlindLabel.className = "rounded-xl font-bold px-2 ring-inset bg-blue-700 ring-blue-800 ring-offset-2 text-white";
              } else {
                smallBlindLabel.className = "rounded-xl font-bold px-2 ring-inset bg-gray-100 ring-gray-300 ring-offset-2 text-gray-300";
              }
            }
            if (bigBlindLabel){
              if (playerInfo["bigBlind"]){
                bigBlindLabel.className = "rounded-xl font-bold px-2 ring-inset bg-yellow-500 ring-yellow-600 ring-offset-2";
              } else {
                bigBlindLabel.className = "rounded-xl font-bold px-2 ring-inset bg-gray-100 ring-gray-300 ring-offset-2 text-gray-300";
              }
            }
            if (handLabel){
              var handString = ""
              for (let j = 0; j < playerInfo["hand"].length; j++) {
                handString = handString + renderCard(playerInfo["hand"][j]);
              }
              handLabel.innerHTML = handString;
            }
    }

    function arrangePlayers(containerTop, containerLeft, containerRight, otherPlayersArray){
      
      let playersCount = otherPlayersArray.length;

      switch (playersCount){
        case 1:
          // put at top middle of screen
          containerTop.appendChild(otherPlayersArray[0]);
          break;
        case 2:
          // put at upper left and upper right
          containerTop.appendChild(otherPlayersArray[0]);
          containerTop.appendChild(otherPlayersArray[1]);
          break;
        case 3:
          // put at mid left, upper middle, and mid right
          containerLeft.appendChild(otherPlayersArray[0]);
          containerTop.appendChild(otherPlayersArray[1]);
          containerRight.appendChild(otherPlayersArray[2]);
          break;
        case 4:
          // put at mid left, two across top and mid right
          containerLeft.appendChild(otherPlayersArray[0]);
          containerTop.appendChild(otherPlayersArray[1]);
          containerTop.appendChild(otherPlayersArray[2]);
          containerRight.appendChild(otherPlayersArray[3]);
          break;
        case 5:
          // put at mid left, three across top and mid right
          containerLeft.appendChild(otherPlayersArray[1]);
          containerLeft.appendChild(otherPlayersArray[0]);
          containerTop.appendChild(otherPlayersArray[2]);
          containerRight.appendChild(otherPlayersArray[3]);
          containerRight.appendChild(otherPlayersArray[4]);
          break;
        case 6:
          // put at two left, two across top and two right
          containerLeft.appendChild(otherPlayersArray[1]);
          containerLeft.appendChild(otherPlayersArray[0]);
          containerTop.appendChild(otherPlayersArray[2]);
          containerTop.appendChild(otherPlayersArray[3]);
          containerRight.appendChild(otherPlayersArray[4]);
          containerRight.appendChild(otherPlayersArray[5]);
          break;
      }
    }

    function updateTable(table){
      if (table){
        // table can and will have multiple pots
        showPots(table["pots"]);
        showCommonCards(table["commonCards"]);
      }
    } 

    function showPots(potsObject){
      if (potsObject){
        let potHolder = document.getElementById('potHolder');
        let keys = Object.keys(potsObject);
        potHolder.innerHTML = "";
        keys.forEach(function(key, index){
          let pot = potsObject[key];
          let keys2 = Object.keys(pot.playerAmounts);
          let potDiv = document.createElement('div');
          potDiv.class = 'pot'
          potDiv.id = 'pot' + index;
          let total = 0;
          keys2.forEach(function(key2){
            total = total + pot.playerAmounts[key2].amount;
          })
          potDiv.innerHTML = "Pot: " + total;
          potHolder.appendChild(potDiv);
        })
      }
    }
    function activatePlayer(playersInfo, table){
      if (table["activeIndex"] !== 'undefined' && table["activeIndex"] != null){
        var activePlayer = playersInfo[table["activeIndex"]];
        for (let i = 0; i < playersInfo.length; i++) {
            var playerBox = document.getElementById("player" + playersInfo[i]["playerId"]);
            if (playerBox){
                playerBox.classList.remove("ring-4");
                playerBox.classList.remove("ring-red-700");
                if (playersInfo[i]["playerId"] == activePlayer.playerId) {
                  playerBox.classList.add("ring-4");
                  playerBox.classList.add("ring-red-700");
                }
            } 
        }
      }
    }
    
    function showCommonCards(cardArray){
        let cardDiv = document.getElementById("commonCards"); 
        cardDiv.innerHTML = ""; // clear list first
        for (let i = 0; i < 5; i++) {
            let newCard = document.createElement('div');
            newCard.classList = "ring ring-red-600 rounded p-2 h-14 w-8 m-1";
            if (i < cardArray.length){
              newCard.innerHTML = renderCard(cardArray[i]);
              
            } else {
              newCard.innerHTML = "";
              newCard.classList.add("checkered");
            }
            cardDiv.appendChild(newCard);
        }
    }

    function renderCard(cardString){
      var num = cardString.charAt(0);
      var suit = cardString.charAt(1);
      if (num == "T"){
        num = "10";
      }
      return (num + htmlSuit(suit))
    } 
    function htmlSuit(suitString){
      switch (suitString) {
        case 'c':
          return "♣";
        case 'd':
          return "🔸";
        case 'h':
          return "🧡";
        case 's':
          return "♠";
        default:
          console.log(`Sorry, no suit match for  ${suitString}.`);
          return suitString;
      }
    }

    function renderErrors(errorsArray){
      let errorDiv = document.getElementById('errorsContainer');
      if (errorsArray.length > 0){
        errorDiv.classList.remove("hidden");
        errorDiv.innerHTML = JSON.stringify(errorsArray);
      } else {
        errorDiv.innerHTML = "";
        errorDiv.classList.remove("hidden");
        errorDiv.classList.add("hidden");
      }
    }

    function renderPlayer(player){
      let playerDiv = document.createElement('div');
      let playerName = document.createElement('div');
      let playerPosition = document.createElement('div');
      let playerButton = document.createElement('div');
      let playerSmallBlind = document.createElement('div');
      let playerBigBlind = document.createElement('div');
      let playerChips = document.createElement('p');
      let playerHand = document.createElement('p');

      playerDiv.id = 'player' + player.playerId;
      playerDiv.className = 'player-box p-4 max-w-sm mx-auto bg-white rounded-xl shadow-lg text-center relative';
      playerName.id = 'player' + player.playerId + 'name';
      playerName.className = 'text-xl font-medium';
      playerChips.id = 'player' + player.playerId + 'chips';
      playerChips.className = 'text-slate-500 absolute right-[-8px] top-[-8px] ring-4 ring-red-300 rounded-xl p-2';
      playerHand.id = 'player' + player.playerId + 'hand';
      playerHand.className = 'text-slate-500';
      playerPosition.id = 'player' + player.playerId + 'position';
      playerPosition.className = 'flex gap-1 absolute bottom-[-8px] left-0';
      playerButton.id = 'player' + player.playerId + 'button';
      playerButton.className = 'rounded-xl font-bold px-2 ring-2 ring-inset';
      playerButton.innerHTML = "D";
      playerSmallBlind.id = 'player' + player.playerId + 'smallBlind';
      playerSmallBlind.className = 'rounded-xl font-bold px-2 ring-2 ring-inset';
      playerSmallBlind.innerHTML = "b";
      playerBigBlind.id = 'player' + player.playerId + 'bigBlind';
      playerBigBlind.className = ' rounded-xl font-bold px-2 ring-2 ring-inset';
      playerBigBlind.innerHTML = "B";


      // '<div id="player1" class="p-6 max-w-sm mx-auto bg-white rounded-xl shadow-lg items-center">'
      //     <div id="player1name" class="text-xl font-medium"></div>
      //     <p id="player1chips" class="text-slate-500"></p>
      //     <p id="player1hand" class="text-slate-500"></p>
      //     <div id="player1button" class="bg-white rounded-xl ring-2 ring-pink-300 ring-inset"></div>
      //     <div id="player1smallBlind" class="bg-blue rounded-xl ring-2 ring-pink-300 ring-inset"></div>
      //     <div id="player1bigBlind" class="bg-yellow rounded-xl ring-2 ring-pink-300 ring-inset"></div>
      // </div>'
      playerDiv.appendChild(playerName);
      playerDiv.appendChild(playerChips);
      playerDiv.appendChild(playerHand);
      playerPosition.appendChild(playerButton);
      playerPosition.appendChild(playerSmallBlind);
      playerPosition.appendChild(playerBigBlind);
      playerDiv.appendChild(playerPosition);
      return playerDiv;
    }
</script>
